---
title: "Data Descriptors for Grand Analysis "
output:
  html_document:
    fig_caption: true
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

<!-- Add the following line manually to the rendered HTML document so that IE does not block the javascript elements: -->
<!-- saved from url=(0014)about:internet --> 
Generates descriptive tables and figures for the Grand Analysis


```{r Setup, message = F, warning = F, echo = F}
knitr::opts_chunk$set(echo = F, warning = F, message = F)

library(tidyverse)
library(kableExtra)
library(knitr)
library(DT)
library(plotly)

project_shared_drive = "//vntscex/DFS/Projects/PROJ-VXK600/MLB48"

output = file.path(project_shared_drive,
                   '2020 Grand Analysis',
                   'Output')

# For dAll data frame, 5233 observations and 31 variables
load(file.path(project_shared_drive,
               '2020 Grand Analysis',
               'GrandAnalysis_CompleteDoseVars.RData'))

dos_vars = c('SELAllAC', 'PEnProps','PEnHelos', 'PTAudAllAC', 'lg10.PTAudAllAC')
dat_vars = c('Dataset', 'Site', 'SiteType', 'Park')
med_vars = c('ImpHistCult_VorMore','ImpNQ_VorMore','SiteFirstVisit', 'DurVisitMinutes')
res_vars = c('Annoy3', 'IntWithNQ3')

d <- dAll

levels(d$SiteType) = c("Overnight", "Dayhike", "Overlook", "ShortHike")

# Re-ordere alphabetically
d$SiteType <- as.factor(as.character(d$SiteType))

levels(d$Dataset) = c('1990s', '2000s', 'Rainbow Bridge')
d$SiteType <- as.factor(as.character(d$SiteType))

```

# Descriptive Tables

```{r tabs}


Dataset_Type_table <- d %>% 
  group_by(Dataset, SiteType) %>%
  summarize(n()) %>%
  pivot_wider(names_from = 'SiteType',
              values_from = 'n()')

datatable(Dataset_Type_table,
          caption = 'Dataset by SiteType, count of observations',
          options = list(dom = 't'),
          rownames = F)

Dataset_Park_table <- d %>% 
  group_by(Dataset, Park) %>%
  summarize(n()) %>%
  pivot_wider(names_from = 'Park',
              values_from = 'n()')

datatable(Dataset_Park_table,
          caption = 'Dataset by Park, count of observations',
          options = list(dom = 't'),
          rownames = F)

Mediators_table <- d %>%
  group_by(SiteType) %>%
  summarize(mean_duration_hrs = round(mean(DurVisitMinutes/60, na.rm=T),2),
            ImpNQ_VorMore = mean(ImpNQ_VorMore == '1', na.rm=T),
            SiteFirstVisit = mean(SiteFirstVisit == 'Yes', na.rm=T),
            AdultsOnly = mean(AdultsOnly == '1', na.rm=T),
            ImpHistCult_VorMore = mean(ImpHistCult_VorMore == 1, na.rm=T),
            )

datatable(Mediators_table, 
          caption = 'Mediators by Site Type. Percentages are for postive responses to those survey questions.',
          options = list(dom = 't',
                         digits = 2),
          rownames = F) %>%
      formatPercentage(columns = ~ ImpNQ_VorMore + SiteFirstVisit + AdultsOnly + ImpHistCult_VorMore, digits = 1)

```

# Descriptive figures

## Sound exposure distributions

Showing dayhike, overnight, and shorthike distributions of LAE and percent of time audible.

```{r hists}
colzbar = c("deepskyblue","deepskyblue4",
            "dodgerblue","dodgerblue4",
            "violetred4","violet")

colzbar[3] = alpha(colzbar[3], 0.3)
colzbar[4] = alpha(colzbar[4], 0.9)
colzbar[5] = alpha(colzbar[5], 0.2)
colzbar[6] = alpha(colzbar[6], 0.2)


par(mfrow = c(1, 2))

with(d[d$SiteType == "Dayhike",], hist(SELAllAC,
                                       xlab = "LAE",
                                       breaks = 25, 
                                       xlim = c(40, 125),
                                       col = colzbar[3],
                                       border = colzbar[3],
                                       main = ""))

with(d[d$SiteType == "Overnight",], hist(SELAllAC,
                                         add = TRUE,
                                         breaks = 15,
                                         col = colzbar[4],
                                         border = colzbar[4]))


with(d[d$SiteType == "ShortHike",], hist(SELAllAC,
                                         add = TRUE,
                                         breaks = 35,
                                         col = colzbar[5],
                                         border = colzbar[4]))


with(d[d$SiteType == "Dayhike",], hist(PTAudAllAC,
                                       xlab = "% Time Audible",
                                       breaks = 25, 
                                       xlim = c(0, 100),
                                       col = colzbar[3],
                                       border = colzbar[3],
                                       main = ""))

with(d[d$SiteType == "Overnight",], hist(PTAudAllAC,
                                         add = TRUE,
                                         breaks = 15,
                                         col = colzbar[4],
                                         border = colzbar[4]))

with(d[d$SiteType == "ShortHike",], hist(PTAudAllAC,
                                         add = TRUE,
                                         breaks = 15,
                                         col = colzbar[5],
                                         border = colzbar[4]))


legend("topright",
       bty = "n",
       fill = c(colzbar[3], colzbar[4], colzbar[5]),
       legend = c("Dayhike", "Overnight", "Shorthike")
)

# fill_cols =  c(scales::alpha("dodgerblue", 0.5),
#                scales::alpha("dodgerblue4", 0.7),
#                scales::alpha("violetred4", 0.8),
#                scales::alpha("violet", 0.2))
# 
# ggplot(d, aes(x = SELAllAC, fill = SiteType)) +
#   geom_histogram(color = 'black') +
#   theme_bw() +
#   scale_fill_manual(values = fill_cols)


```


## Sound exposure and responses by site type

In the figures below, colors represent site types, while size of the points represents number of respondents.

```{r fig2}
annoy_LAE <- d %>%
  group_by(Annoy3, SiteType) %>%
  summarize(meanLAE = mean(SELAllAC, na.rm = T),
            n_respond = n())

gp_a <- ggplot(annoy_LAE, aes(x = meanLAE, y = Annoy3, size = n_respond, color = SiteType)) +
  geom_point() + scale_size(range = c(1, 9)) +
  theme_bw() +
  ggtitle('Site visitors reporting annoyance by mean sound exposure') +
  ylab('Annoyance level') + xlab('Mean LAE')

int_LAE <- d %>%
  group_by(IntWithNQ3, SiteType) %>%
  summarize(meanLAE = mean(SELAllAC, na.rm = T),
            n_respond = n())

gp_i <- ggplot(int_LAE, aes(x = meanLAE, y = IntWithNQ3, size = n_respond, color = SiteType)) +
  geom_point() + scale_size(range = c(1, 9)) +
  theme_bw() +
  ggtitle('Site visitors reporting interference by mean sound exposure') +
  ylab('Interference level') + xlab('Mean LAE')

ggplotly(gp_a)

ggplotly(gp_i)


```


```{r interpret_cutoff}
annoy_LAE <- d %>%
  group_by(Annoy3) %>%
  summarize(meanLAE = mean(SELAllAC, na.rm = T),
            n_respond = n())

gp_a <- ggplot(annoy_LAE, aes(x = meanLAE, y = Annoy3, size = n_respond)) +
  geom_point() + scale_size(range = c(1, 9)) +
  theme_bw() +
  ggtitle('Site visitors reporting annoyance by mean sound exposure') +
  ylab('Annoyance level') + xlab('Mean LAE')

ggplotly(gp_a)



```